!function(t,e){if("function"==typeof define&&define.amd)define(["underscore","backbone"],function(r,s){return e(t,s,r)});else if("undefined"!=typeof exports){var r=require("underscore"),s=require("backbone");e(t,s,r),"undefined"!=typeof module&&module.exports&&(module.exports=s),exports=s}else e(t,t.Backbone,t._)}(this,function(t,e,r){"use strict";var s={start:e.History.prototype.start,atRoot:e.History.prototype.atRoot,navigate:e.History.prototype.navigate};return e.History.prototype.start=function(t){var e=this.prototype||this.__proto__;this.checkUrl=e.checkUrl.bind(this),t.hashChange=t.hashMate?!0:t.hashChange,this._hasHashMate=!!t.hashMate,this._noRootCheck=!0;var r=s.start.call(this,t);return delete this._noRootCheck,r},e.History.prototype.atRoot=function(){return this._hasHashMate&&this._noRootCheck?!1:s.atRoot.call(this)},e.History.prototype.checkUrl=function(){return this.getFragment()!==this.fragment||this.hashString!==this.getHashString()&&this._hasHashMate?this.navigationInProgress?!1:(this.hashString=this.getHashString(),void this.loadUrl()):!1},e.History.prototype.navigate=function(t,e){"object"!=typeof t||e||(e=t,t=this.fragment),e=e||{};var n="";if(this.navigationInProgress=!0,n=e.deleteHash&&this.deleteHash("object"==typeof e.deleteHash?r.extend(e.deleteHash,{apply:!1}):{apply:!1}),n=e.deleteHash||e.addHash?this.setHash(e.addHash,n,{apply:!0}):this.getHashString(n),e.forceTrigger)this.fragment="";else if(this.fragment===t&&n===this.hashString)return void(this.navigationInProgress=!1);s.navigate.call(this,t+"#"+n,e),this.hashString=n,this.navigationInProgress=!1},e.History.prototype.deleteHash=function(t,e){t=t||{},t.apply=e?!1:"boolean"==typeof t.apply?t.apply:!0,t.params="string"==typeof t.params?[t.params]:t.params,t.groups="string"==typeof t.groups?[t.groups]:t.groups,t.globals="string"==typeof t.globals?[t.globals]:t.globals;var r=this.parseHashString(e);if(t.groups||t.globals||t.params){var s,n=t.groups instanceof Array,i=t.params instanceof Array;for(var o in r)if(s=o.indexOf("/")>-1?!0:!1,!s&&t.globals)delete r[o];else if(s&&t.groups){if(n&&-1===t.groups.indexOf(o.split("/")[0]))continue;delete r[o]}else i&&-1!==t.params.indexOf(o)&&delete r[o];r&&!Object.keys(r).length&&(r=null)}else r=null;return this.setHashString(r,t)},e.History.prototype.pluckHash=function(t,e){var r=!1;t&&"string"==typeof t&&(r=!0,t=[t]);var s={},n=this.parseHashString();if(t&&t.length){var i=[];t.forEach(function(t){var r=t;r.length&&t.indexOf("/")===t.lastIndexOf("/")&&(e&&-1===t.indexOf("/")&&(r=e+"/"+t[0]),-1===i.indexOf(r)&&i.push(r))}),i.forEach(function(t){s[t]=n[t]?n[t]:""})}else if(e)for(var o in n)0===o.indexOf(e+"/")&&(s[o]=n[o]);else for(var o in n)-1===o.indexOf("/")&&(s[o]=n[o]);if(r&&1===Object.keys(s).length)for(var a in s)return s[a];return s},e.History.prototype.setHash=function(t,e,r){"object"==typeof e&&(r=e,e=null),r=r||{},r.apply="boolean"==typeof r.apply?r.apply:!0,e=this.getHashString(e),t="string"==typeof t?this.parseHashString(t):t||"";var s=this.parseHashString(e);for(var n in t)s[n]=t[n];var i=this.setHashString(s,r);return r.returnLiteral?s:i},e.History.prototype.matchHashString=function(t,e){return t===this.getHashString(e)?!0:!1},e.History.prototype.parseHashString=function(t){var e=this.getHashString(t);if(!e.length||-1===e.indexOf("="))return{};var r={};return e=e.split("&"),e.forEach(function(t){t=t.split("="),2===t.length&&t[0].length&&t[1].length?r[t[0]]=decodeURIComponent(t[1]):1===t.length&&t[0].length&&(r[t[0]]="")}),r},e.History.prototype.getHashString=function(t){return("string"==typeof t?t:this.getHash(window)).replace(/^#*/g,"")},e.History.prototype.setHashString=function(t,e){var r=[];if(t)for(var s in t)("boolean"==typeof t[s]||"number"==typeof t[s])&&(t[s]=t[s].toString()),r.push("string"==typeof t[s]&&t[s].length?s+"="+encodeURIComponent(t[s]):s);return r=r&&r.length?r.join("&"):"",e=e||{},e.apply!==!1&&(this.navigationInProgress=!0,this._updateHash(this.location||window.location,r,e.replace),this.hashString=r,this.navigationInProgress=!1),r},e});