!function(t,e){if("function"==typeof define&&define.amd)define(["underscore","backbone"],function(r,n){return e(t,n,r)});else if("undefined"!=typeof exports){var r=require("underscore"),n=require("backbone");e(t,n,r),"undefined"!=typeof module&&module.exports&&(module.exports=n),exports=n}else e(t,t.Backbone,t._)}(this,function(t,e,r){"use strict";var n=e.History.prototype.start;e.History.prototype.start=function(t){var e=this.prototype||this.__proto__;this.checkUrl=e.checkUrl.bind(this),t.hashChange=t.hashMate?!0:t.hashChange;var r=n.call(this,t);return r},e.History.prototype.checkUrl=function(){return this.getFragment()!==this.fragment||this.hashString!==this.getHashString()&&this.options.hashMate?(this.hashString=this.getHashString(),void this.loadUrl()):!1};var i=e.History.prototype.navigate;return e.History.prototype.navigate=function(t,e){e=e||{};var n="";if(this.navigationInProgress=!0,n=e.deleteHash&&this.deleteHash("object"==typeof e.deleteHash?r.extend(e.deleteHash,{apply:!1}):{apply:!1}),n=e.deleteHash||e.addHash?this.setHash(e.addHash,n,{apply:!0}):this.getHashString(n),e.forceTrigger)this.fragment="";else if(this.fragment===t&&n===this.hashString)return void(this.navigationInProgress=!1);i.call(this,t+"#"+n,e),this.hashString=n,this.navigationInProgress=!1},e.History.prototype.deleteHash=function(t){t=t||{},t.apply=t.target?!1:"boolean"==typeof t.apply?t.apply:!0,t.groups="string"==typeof t.groups?[t.groups]:t.groups,t.globals="string"==typeof t.globals?[t.globals]:t.globals;var e=this.parseHashString(t.target);if(t.groups||t.globals){var r;for(var n in e)if(r=n.indexOf("/")>-1?"groups":"globals",t[r]){if(t[r]instanceof Array&&-1===t[r].indexOf(n.split("/")[0]))continue;delete e[n]}e&&!Object.keys(e).length&&(e=null)}else e=null;return this.setHashString(e,t)},e.History.prototype.pluckHash=function(t,e){var r=!1;t&&"string"==typeof t&&(r=!0,t=[t]);var n={},i=this.parseHashString();if(t&&t.length){var s=[];t.forEach(function(t){var r=t;r.length&&t.indexOf("/")===t.lastIndexOf("/")&&(e&&-1===t.indexOf("/")&&(r=e+"/"+t[0]),-1===s.indexOf(r)&&s.push(r))}),s.forEach(function(t){n[t]=i[t]?i[t]:""})}else if(e)for(var o in i)0===o.indexOf(e+"/")&&(n[o]=i[o]);else for(var o in i)-1===o.indexOf("/")&&(n[o]=i[o]);if(r&&1===Object.keys(n).length)for(var a in n)return n[a];return n},e.History.prototype.setHash=function(t,e,r){"object"==typeof e&&(r=e,e=null),r=r||{},r.apply=r.apply||!1,e=this.getHashString(e),t="string"==typeof t?this.parseHashString(t):t||"";var n=this.parseHashString(e);for(var i in t)n[i]=t[i];var s=this.setHashString(n,r);return r.returnLiteral?n:s},e.History.prototype.matchHashString=function(t,e){return t===this.getHashString(e)?!0:!1},e.History.prototype.parseHashString=function(t){var e=this.getHashString(t);if(!e.length||-1===e.indexOf("="))return{};var r={};return e=e.split("&"),e.forEach(function(t){t=t.split("="),2===t.length&&t[0].length&&t[1].length?r[t[0]]=decodeURIComponent(t[1]):1===t.length&&t[0].length&&(r[t[0]]="")}),r},e.History.prototype.getHashString=function(t){return("string"==typeof t?t:this.getHash(window)).replace(/^#*/g,"")},e.History.prototype.setHashString=function(t,e){var r=[];if(t)for(var n in t)("boolean"==typeof t[n]||"number"==typeof t[n])&&(t[n]=t[n].toString()),r.push("string"==typeof t[n]&&t[n].length?n+"="+encodeURIComponent(t[n]):n);return r=r&&r.length?r.join("&"):"",e=e||{},e.apply&&(this._updateHash(this.location||window.location,r,e.replace),this.hashString=r),r},e});